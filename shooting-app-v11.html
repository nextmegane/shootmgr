<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHOOTMGR</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap');

  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #242424;
    --border: #2e2e2e;
    --accent: #ff5c00;
    --accent2: #ffb800;
    --text: #f0f0f0;
    --text-muted: #888;
    --success: #00c97a;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 100;
  }
  .logo { font-family: 'Space Mono', monospace; font-size: 17px; font-weight: 700; color: var(--accent); }
  .logo span { color: var(--text); }
  .header-right { margin-left: auto; display: flex; gap: 10px; align-items: center; }
  .progress-badge {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 4px 14px; font-size: 13px; color: var(--text-muted);
  }
  .progress-badge b { color: var(--success); }

  .tabs {
    display: flex; border-bottom: 1px solid var(--border); padding: 0 20px;
    overflow-x: auto; background: var(--bg);
    position: sticky; top: 53px; z-index: 99;
  }
  .tab {
    padding: 12px 18px; font-size: 13px; color: var(--text-muted);
    cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;
    white-space: nowrap; background: none; border-left: none; border-right: none; border-top: none;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .screen { display: none; padding: 20px; max-width: 780px; margin: 0 auto; }
  .screen.active { display: block; }

  .source-toggle { display: flex; gap: 8px; margin-bottom: 16px; }
  .source-btn {
    flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-muted); cursor: pointer;
    font-size: 13px; font-weight: 700; transition: all 0.2s; text-align: center;
  }
  .source-btn.active { border-color: var(--accent); color: var(--accent); background: #1f1200; }

  .upload-zone {
    border: 2px dashed var(--border); border-radius: var(--radius);
    padding: 50px 20px; text-align: center; cursor: pointer;
    transition: all 0.2s; background: var(--surface); position: relative;
  }
  .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: #1f1200; }
  .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-icon { font-size: 44px; margin-bottom: 12px; }
  .upload-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .upload-sub { color: var(--text-muted); font-size: 13px; }

  .sheets-input-area { display: none; }
  .sheets-input-area.visible { display: block; }

  .input-group { margin-bottom: 12px; }
  .input-label { font-size: 12px; font-family: 'Space Mono', monospace; color: var(--text-muted); margin-bottom: 6px; display: block; }
  .input-field {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 14px; color: var(--text); font-size: 14px;
    font-family: 'Noto Sans JP', sans-serif;
  }
  .input-field:focus { outline: none; border-color: var(--accent); }
  .sheets-help {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.7;
  }
  .sheets-help b { color: var(--text); }

  .parse-status {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px; margin-bottom: 16px;
  }
  .parse-info { font-size: 13px; color: var(--text-muted); margin-bottom: 14px; }
  .column-map { display: grid; gap: 8px; }
  .col-row { display: flex; gap: 10px; align-items: center; }
  .col-label { width: 130px; color: var(--text-muted); font-size: 11px; font-family: 'Space Mono', monospace; flex-shrink: 0; }
  .col-select {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); border-radius: 8px; padding: 8px 10px; font-size: 13px;
  }
  .col-select:focus { outline: none; border-color: var(--accent); }

  .btn {
    display: inline-flex; align-items: center; gap: 6px; padding: 11px 20px;
    border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer;
    border: none; transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #ff7722; }
  .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: #555; }
  .btn-sm { padding: 7px 14px; font-size: 12px; }
  .btn-full { width: 100%; justify-content: center; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .list-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px; gap: 10px; flex-wrap: wrap;
  }
  .list-title { font-size: 17px; font-weight: 700; }
  .filter-tabs { display: flex; gap: 6px; }
  .filter-btn {
    padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;
    cursor: pointer; border: 1px solid var(--border); background: var(--surface2);
    color: var(--text-muted); transition: all 0.15s;
  }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .shoot-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); margin-bottom: 10px; overflow: hidden; transition: border-color 0.2s;
  }
  .shoot-card.done { border-color: #00c97a44; }

  .shoot-card-header {
    display: flex; align-items: center; padding: 14px 16px; gap: 10px; cursor: pointer;
  }
  .scene-num {
    font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text-muted);
    background: var(--surface2); border: 1px solid var(--border); border-radius: 5px;
    padding: 3px 7px; min-width: 38px; text-align: center; flex-shrink: 0;
  }
  .scene-title { font-weight: 700; font-size: 14px; flex: 1; line-height: 1.4; }
  .status-pill {
    font-size: 10px; font-weight: 700; border-radius: 10px; padding: 3px 9px; flex-shrink: 0;
    background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border);
  }
  .done .status-pill { background: #00c97a22; color: var(--success); border-color: #00c97a44; }
  .chevron { color: var(--text-muted); font-size: 11px; transition: transform 0.2s; flex-shrink: 0; }
  .shoot-card.open .chevron { transform: rotate(90deg); }

  .shoot-card-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }
  .shoot-card.open .shoot-card-body { display: block; animation: slideDown 0.18s ease; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .detail-label {
    font-size: 10px; font-family: 'Space Mono', monospace; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px; margin-top: 14px; margin-bottom: 6px;
  }
  .detail-text { font-size: 13px; line-height: 1.6; }

  .video-ref-box {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
  }
  .video-ref-meta { display: flex; align-items: center; gap: 10px; padding: 10px 12px; }
  .video-ref-icon { font-size: 18px; }
  .video-ref-info { flex: 1; min-width: 0; }
  .platform-badge {
    font-size: 10px; font-weight: 700; font-family: 'Space Mono', monospace;
    color: var(--text-muted); margin-bottom: 2px; text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .video-ref-url {
    font-size: 11px; color: var(--accent); word-break: break-all;
    text-decoration: none; display: block; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }
  .video-ref-url:hover { text-decoration: underline; }
  .video-ref-time {
    font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent2); margin-top: 2px;
  }
  .video-preview-toggle {
    background: none; border: none; color: var(--accent); font-size: 11px;
    cursor: pointer; padding: 0; font-weight: 700; white-space: nowrap; flex-shrink: 0;
  }

  .video-embed-wrap {
    display: none; border-top: 1px solid var(--border); background: #000; position: relative; padding-top: 56.25%;
  }
  .video-embed-wrap.visible { display: block; }
  .video-embed-wrap iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

  .video-count-badge {
    display: inline-block; background: var(--accent); color: #fff;
    border-radius: 10px; padding: 1px 8px; font-size: 10px;
    font-weight: 700; margin-left: 6px; vertical-align: middle;
  }
  .shot-video-item {
    border-radius: 8px; overflow: hidden; background: #000;
    border: 1px solid var(--border); margin-bottom: 8px; margin-top: 4px;
  }
  .shot-video-item video { width: 100%; display: block; max-height: 240px; }
  .shot-video-drop {
    border: 2px dashed var(--border); border-radius: 8px; padding: 16px;
    text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
    font-size: 13px; color: var(--text-muted); margin-top: 4px;
  }
  .shot-video-drop:hover { border-color: var(--accent); color: var(--text); }
  .shot-video-drop input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

  .shot-video-preview {
    display: none; border-radius: 8px; overflow: hidden;
    background: #000; border: 1px solid var(--border); margin-top: 8px;
  }
  .shot-video-preview.visible { display: block; }
  .shot-video-preview video { width: 100%; display: block; max-height: 260px; }
  .shot-video-info {
    padding: 10px 12px; display: flex; align-items: center; justify-content: space-between;
    gap: 10px; border-top: 1px solid var(--border);
  }
  .shot-video-name { font-size: 11px; font-family: 'Space Mono', monospace; color: var(--accent2); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .shoot-actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
  .done-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: #00c97a18; border: 1px solid #00c97a44;
    color: var(--success); border-radius: 6px; padding: 6px 12px;
    font-size: 12px; font-weight: 700; margin-top: 14px;
  }

  .export-summary {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px; text-align: center; margin-bottom: 16px;
  }
  .export-num { font-size: 44px; font-weight: 700; color: var(--accent); font-family: 'Space Mono', monospace; }
  .export-label { color: var(--text-muted); font-size: 13px; margin-top: 4px; }
  .export-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .export-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 18px; text-align: center; cursor: pointer; transition: all 0.2s;
  }
  .export-card:hover { border-color: var(--accent); background: #1f1200; }
  .export-card-icon { font-size: 28px; margin-bottom: 8px; }
  .export-card-title { font-weight: 700; font-size: 14px; }
  .export-card-sub { color: var(--text-muted); font-size: 11px; margin-top: 4px; }

  /* â”€â”€ GAS STEPS â”€â”€ */
  .gas-steps {
    display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
  }
  .gas-step {
    flex: 1; display: flex; align-items: center; gap: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: all 0.2s;
  }
  .gas-step.active { border-color: var(--accent); background: #1f1200; }
  .gas-step-num {
    width: 24px; height: 24px; border-radius: 50%; background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; font-family: 'Space Mono', monospace;
    flex-shrink: 0;
  }
  .gas-step.active .gas-step-num { background: var(--accent); color: #fff; }
  .gas-step-label { font-size: 12px; font-weight: 700; }
  .gas-step-arrow { color: var(--text-muted); font-size: 16px; flex-shrink: 0; }

  /* â”€â”€ CODE BLOCK â”€â”€ */
  .code-block {
    background: #0a0a0a; border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
  }
  .code-block-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 14px; border-bottom: 1px solid var(--border);
    font-size: 11px; color: var(--text-muted); font-family: 'Space Mono', monospace;
  }
  .copy-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); border-radius: 6px; padding: 4px 10px;
    font-size: 11px; cursor: pointer; transition: all 0.15s;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  pre#gasCode {
    padding: 14px; font-family: 'Space Mono', monospace; font-size: 11px;
    line-height: 1.6; color: #ccc; overflow-x: auto; margin: 0;
    white-space: pre;
  }

  .video-tap-wrap {
    position: relative; cursor: pointer; background: #000;
  }
  .play-overlay {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.3);
    transition: opacity 0.2s;
  }
  .play-btn-big {
    width: 56px; height: 56px; border-radius: 50%;
    background: rgba(255,92,0,0.9);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; color: #fff; padding-left: 4px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.4);
  }
  .camera-note {
    font-size: 11px; color: var(--text-muted); margin-top: 10px;
    padding: 8px 10px; background: var(--surface2); border-radius: 6px;
    border-left: 2px solid var(--accent2); line-height: 1.5;
  }
  .demo-link {
    display: block; text-align: center; margin-top: 14px;
    color: var(--text-muted); font-size: 13px; cursor: pointer; text-decoration: underline;
  }

  .toast {
    position: fixed; bottom: 20px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 18px; font-size: 13px;
    z-index: 999; transition: transform 0.3s; white-space: nowrap; max-width: 90vw;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .empty { text-align: center; padding: 50px 20px; color: var(--text-muted); }
  .empty-icon { font-size: 44px; margin-bottom: 10px; }
  .loading { text-align: center; padding: 24px; color: var(--text-muted); font-size: 14px; }
  /* â”€â”€ PROMPTER â”€â”€ */
  #prompterOverlay {
    position: fixed; inset: 0; z-index: 500;
    background: #000; display: flex; flex-direction: column;
  }
  #prompterSetup, #prompterSession {
    display: flex; flex-direction: column; height: 100%;
  }
  .prompter-header {
    display: flex; align-items: center; gap: 12px;
    padding: 16px 20px; border-bottom: 1px solid #222; flex-shrink: 0;
  }
  .prompter-title {
    flex: 1; font-size: 13px; color: #888;
    font-family: 'Space Mono', monospace;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .prompter-counter {
    font-family: 'Space Mono', monospace; font-size: 13px; color: var(--accent); flex-shrink: 0;
  }
  .prompter-close {
    background: #222; border: none; color: #aaa; font-size: 16px;
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }

  /* SETUP */
  .setup-body {
    flex: 1; padding: 28px 20px; overflow-y: auto;
  }
  .setup-label {
    font-size: 11px; font-family: 'Space Mono', monospace; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
  }
  .setup-options { display: flex; gap: 10px; }
  .setup-opt {
    flex: 1; padding: 14px 8px; border-radius: 12px;
    border: 1px solid #333; background: #1a1a1a; color: #fff;
    cursor: pointer; transition: all 0.15s; text-align: center;
  }
  .setup-opt.active { border-color: var(--accent); background: #1f1200; }
  .setup-opt-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
  .setup-opt-sub   { font-size: 11px; color: #888; }
  .setup-desc { display: flex; flex-direction: column; gap: 10px; }
  .setup-desc-row {
    display: flex; gap: 10px; align-items: flex-start;
    font-size: 13px; color: #aaa; line-height: 1.5;
  }

  /* SESSION */
  .tap-zone-left, .tap-zone-right {
    position: absolute; top: 60px; bottom: 120px; width: 50%; z-index: 10;
    cursor: pointer;
  }
  .tap-zone-left  { left: 0; }
  .tap-zone-right { right: 0; }

  .prompter-body {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 20px 24px; pointer-events: none;
  }
  .prompter-direction {
    margin-top: 16px; font-size: 14px; color: #aaa;
    background: #1a1a1a; border: 1px solid #333;
    border-radius: 8px; padding: 8px 14px;
    text-align: center; line-height: 1.5;
    max-width: 80%; pointer-events: none;
  }
  .prompter-speaker-label {
    font-family: 'Space Mono', monospace; font-size: 12px;
    color: var(--accent); letter-spacing: 1px; margin-bottom: 16px;
    text-transform: uppercase;
  }
  .prompter-text {
    font-size: clamp(26px, 7vw, 48px); font-weight: 700;
    color: #fff; line-height: 1.5; text-align: center; word-break: break-all;
  }
  .prompter-text.slide-left  { animation: slideInLeft  0.2s ease; }
  .prompter-text.slide-right { animation: slideInRight 0.2s ease; }
  @keyframes slideInLeft  { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
  @keyframes slideInRight { from { opacity:0; transform:translateX(-40px); } to { opacity:1; transform:translateX(0); } }

  /* STATUS BAR */
  .prompter-status {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 10px; flex-shrink: 0;
  }
  .status-icon { font-size: 20px; }
  .status-msg  { font-size: 13px; color: #aaa; }

  /* TRANSCRIPT */
  .prompter-transcript {
    margin: 0 16px; padding: 12px 16px;
    background: #1a0000; border: 1px solid #ff3333;
    border-radius: 10px; flex-shrink: 0;
  }
  .transcript-label { font-size: 10px; color: #ff6666; font-family: 'Space Mono', monospace; margin-bottom: 6px; }
  .transcript-text  { font-size: 16px; color: #fff; line-height: 1.5; }

  /* BOTTOM HINT */
  .prompter-hint {
    display: flex; height: 64px; flex-shrink: 0;
    border-top: 1px solid #222; margin-top: 8px;
  }
  .hint-left, .hint-right {
    flex: 1; display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700; cursor: pointer; color: #555;
    transition: background 0.15s;
  }
  .hint-left  { border-right: 1px solid #222; }
  .hint-left:active, .hint-right:active { background: #1a1a1a; color: #fff; }

  /* â”€â”€ SCRIPT UI â”€â”€ */
  .script-preview {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px; margin-top: 4px;
  }
  .script-line {
    display: flex; gap: 10px; padding: 4px 0;
    border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .script-line:last-child { border-bottom: none; }
  .script-speaker {
    font-family: 'Space Mono', monospace; font-size: 10px;
    color: var(--accent); min-width: 60px; flex-shrink: 0;
    padding-top: 2px;
  }
  .script-text { color: var(--text); line-height: 1.5; }

  .prompter-speaker {
    font-size: 0.45em; font-family: 'Space Mono', monospace;
    color: var(--accent); margin-bottom: 12px; letter-spacing: 1px;
    text-transform: uppercase;
  }

  .gap { height: 16px; }
</style>
</head>
<body>

<header>
  <div class="logo">SHOOT<span>MGR</span></div>
  <div class="header-right">
    <div class="progress-badge" id="progressBadge" style="display:none">
      <b id="doneCount">0</b> / <span id="totalCount">0</span> å®Œäº†
    </div>
  </div>
</header>

<div class="tabs">
  <button class="tab active" onclick="switchTab('upload', this)">ğŸ“ æŒ‡ç¤ºæ›¸</button>
  <button class="tab" onclick="switchTab('list', this)">ğŸ“‹ æ’®å½±ãƒªã‚¹ãƒˆ</button>
  <button class="tab" onclick="switchTab('export', this)">ğŸ“¦ å‡ºåŠ›</button>
</div>

<!-- â‘  UPLOAD -->
<div class="screen active" id="screen-upload">
  <div class="gap"></div>
  <div class="source-toggle" id="instructionSourceToggle">
    <button class="source-btn active" id="srcBtnExcel" onclick="setSource('excel')">ğŸ“Š Excel (.xlsx)</button>
    <button class="source-btn" id="srcBtnSheets" onclick="setSource('sheets')">ğŸŸ¢ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</button>
  </div>

  <div id="excelArea">
    <div class="upload-zone" id="uploadZone">
      <input type="file" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
      <div class="upload-icon">ğŸ“‹</div>
      <div class="upload-title">Excelã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
      <div class="upload-sub">.xlsx ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</div>
    </div>
  </div>

  <div id="sheetsArea" class="sheets-input-area">

    <!-- STEP INDICATOR -->
    <div class="gas-steps">
      <div class="gas-step" id="gasStep1" onclick="showGasStep(1)">
        <div class="gas-step-num">1</div>
        <div class="gas-step-label">GASã‚’è¨­å®š</div>
      </div>
      <div class="gas-step-arrow">â†’</div>
      <div class="gas-step" id="gasStep2" onclick="showGasStep(2)">
        <div class="gas-step-num">2</div>
        <div class="gas-step-label">URLã‚’è²¼ã‚Šä»˜ã‘</div>
      </div>
    </div>

    <!-- STEP 1: GAS SETUP GUIDE -->
    <div id="gasStepPanel1">
      <div class="sheets-help">
        <b>ğŸ“Œ Google Apps Script ã®è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰</b><br><br>
        <b>â‘  </b>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€<br>
        <b>â‘¡ </b>ã‚¨ãƒ‡ã‚£ã‚¿ã®ä¸­èº«ã‚’å…¨æ¶ˆã—ã—ã¦ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘<br>
        <b>â‘¢ </b>ä¿å­˜ï¼ˆCtrl+Sï¼‰â†’ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€<br>
        <b>â‘£ </b>ç¨®é¡ï¼šã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª ï¼ ã‚¢ã‚¯ã‚»ã‚¹ï¼š<b style="color:#ff5c00">å…¨å“¡</b> â†’ ãƒ‡ãƒ—ãƒ­ã‚¤<br>
        <b>â‘¤ </b>ç™ºè¡Œã•ã‚ŒãŸURLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
      </div>
      <div class="code-block">
        <div class="code-block-header">
          <span>GAS ã‚³ãƒ¼ãƒ‰</span>
          <button class="copy-btn" onclick="copyCode()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>
        <pre id="gasCode">function doGet(e) {
  const sheetId = e.parameter.id;
  const sheetName = e.parameter.sheet || '';
  const ss = SpreadsheetApp.openById(sheetId);
  const sheet = sheetName
    ? ss.getSheetByName(sheetName)
    : ss.getSheets()[0];
  const data = sheet.getDataRange().getValues();
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
      </div>
      <button class="btn btn-primary btn-full" style="margin-top:12px" onclick="showGasStep(2)">âœ… è¨­å®šã§ããŸ â†’ æ¬¡ã¸</button>
    </div>

    <!-- STEP 2: URL INPUT -->
    <div id="gasStepPanel2" style="display:none">
      <div class="sheets-help">
        <b>ğŸ“Œ GASãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</b><br>
        <span style="color:#ff5c00">https://script.google.com/macros/s/...../exec</span> ã®å½¢ã®URL
      </div>
      <div class="input-group">
        <label class="input-label">GAS ãƒ‡ãƒ—ãƒ­ã‚¤URL</label>
        <input class="input-field" id="gasUrl" placeholder="https://script.google.com/macros/s/...../exec">
      </div>
      <div class="input-group">
        <label class="input-label">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDï¼ˆURLã® /d/ ã®å¾Œã‚ï¼‰</label>
        <input class="input-field" id="sheetsId" placeholder="1Txa8zKzDVo1qOOlu3DepG104X3AeTKhOwhnVRAfmD34" oninput="autoFillId(this.value)">
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚‹ã¨è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</div>
      </div>
      <div class="input-group">
        <label class="input-label">ã‚·ãƒ¼ãƒˆåï¼ˆä»»æ„ãƒ»ç©ºç™½ã§1æšç›®ï¼‰</label>
        <input class="input-field" id="sheetsName" placeholder="ä¾‹: ã‚·ãƒ¼ãƒˆ1">
      </div>
      <button class="btn btn-primary btn-full" onclick="loadSheets()">ğŸŸ¢ èª­ã¿è¾¼ã‚€</button>
      <button class="btn btn-ghost btn-full" style="margin-top:8px" onclick="showGasStep(1)">â† GASè¨­å®šã«æˆ»ã‚‹</button>
      <div id="sheetsLoading" class="loading" style="display:none">â³ èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

  </div>

  <!-- å°æœ¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <div style="margin-top:12px">
    <div class="source-toggle">
      <button class="source-btn active" id="modeInstruction" onclick="setMode('instruction')">ğŸ“‹ æŒ‡ç¤ºæ›¸ãƒ¢ãƒ¼ãƒ‰</button>
      <button class="source-btn" id="modeScript" onclick="setMode('script')">ğŸ¬ å°æœ¬ãƒ¢ãƒ¼ãƒ‰</button>
    </div>
  </div>

  <div id="scriptUploadArea" style="display:none; margin-top:4px;">
    <div class="upload-zone" id="scriptUploadZone">
      <input type="file" accept=".xlsx,.xls" onchange="handleScriptFile(this.files[0])">
      <div class="upload-icon">ğŸ¬</div>
      <div class="upload-title">å°æœ¬Excelã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
      <div class="upload-sub">ã‚·ãƒ¼ãƒˆï¼ã‚·ãƒŠãƒªã‚ªã€åˆ—ï¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ã®å½¢å¼ã«å¯¾å¿œ</div>
    </div>
    <div id="scriptParseSection" style="display:none; margin-top:16px;"></div>
  </div>

  <a class="demo-link" onclick="loadDemo()">ğŸ“Œ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</a>

  <div id="parseSection" style="display:none; margin-top:20px;">
    <div class="parse-status">
      <div class="parse-info" id="parseInfo"></div>
      <div class="column-map" id="columnMap"></div>
    </div>
    <button class="btn btn-primary btn-full" onclick="buildList()">âœ… æ’®å½±ãƒªã‚¹ãƒˆã‚’ä½œæˆ</button>
  </div>
</div>

<!-- â‘¡ LIST -->
<div class="screen" id="screen-list">
  <div class="list-header">
    <div class="list-title">æ’®å½±ãƒªã‚¹ãƒˆ</div>
    <div class="filter-tabs">
      <button class="filter-btn active" onclick="filterList('all', this)">ã™ã¹ã¦</button>
      <button class="filter-btn" onclick="filterList('todo', this)">æœªå®Œäº†</button>
      <button class="filter-btn" onclick="filterList('done', this)">å®Œäº†</button>
    </div>
  </div>
  <div id="shootList"></div>
</div>

<!-- â‘¢ EXPORT -->
<div class="screen" id="screen-export">
  <div class="gap"></div>
  <div class="export-summary">
    <div class="export-num" id="exportDone">0</div>
    <div class="export-label">ä»¶ã®æ’®å½±ãŒå®Œäº†ã—ã¦ã„ã¾ã™</div>
  </div>
  <div class="export-grid">
    <div class="export-card" onclick="exportCSV()">
      <div class="export-card-icon">ğŸ“Š</div>
      <div class="export-card-title">CSV å‡ºåŠ›</div>
      <div class="export-card-sub">æ’®å½±ãƒªã‚¹ãƒˆã‚’CSVä¿å­˜</div>
    </div>
    <div class="export-card" onclick="showToast('ğŸ—œï¸ ZIPæ©Ÿèƒ½ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªç‰ˆã§å¯¾å¿œäºˆå®š')">
      <div class="export-card-icon">ğŸ—œï¸</div>
      <div class="export-card-title">ZIP ã¾ã¨ã‚</div>
      <div class="export-card-sub">å‹•ç”»ã‚’ä¸€æ‹¬ZIPã§å‡ºåŠ›</div>
    </div>
  </div>
  <button class="btn btn-ghost btn-full" onclick="showToast('ğŸ“¤ ç´å“ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆã‚¢ãƒ—ãƒªç‰ˆã§å¯¾å¿œï¼‰')">ğŸ“¤ ç´å“ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã</button>
</div>

<div class="toast" id="toast"></div>

<!-- PROMPTER OVERLAY -->
<div id="prompterOverlay" style="display:none">

  <!-- SETUP SCREEN -->
  <div id="prompterSetup">
    <div class="prompter-header">
      <div class="prompter-title" id="prompterTitle"></div>
      <button class="prompter-close" onclick="closePrompter()">âœ•</button>
    </div>
    <div class="setup-body">
      <div class="setup-label">åˆ¤å®šã®è¨±å®¹åº¦</div>
      <div class="setup-options">
        <button class="setup-opt" id="opt-loose" onclick="selectTolerance('loose')">
          <div class="setup-opt-title">ã‚†ã‚‹ã„</div>
          <div class="setup-opt-sub">70%ä»¥ä¸Šã§ä¸€è‡´</div>
        </button>
        <button class="setup-opt active" id="opt-normal" onclick="selectTolerance('normal')">
          <div class="setup-opt-title">æ™®é€š</div>
          <div class="setup-opt-sub">85%ä»¥ä¸Šã§ä¸€è‡´</div>
        </button>
        <button class="setup-opt" id="opt-strict" onclick="selectTolerance('strict')">
          <div class="setup-opt-title">å³ã—ã„</div>
          <div class="setup-opt-sub">95%ä»¥ä¸Šã§ä¸€è‡´</div>
        </button>
      </div>
      <div class="setup-label" style="margin-top:24px">æ“ä½œæ–¹æ³•</div>
      <div class="setup-desc">
        <div class="setup-desc-row">ğŸ”Š <span>ã‚¢ãƒ—ãƒªãŒã‚»ãƒªãƒ•ã‚’èª­ã¿ä¸Šã’ã‚‹</span></div>
        <div class="setup-desc-row">ğŸ¬ <span>æ¼”è€…ãŒæ¼”æŠ€ãƒ»å¾©å”±ã™ã‚‹</span></div>
        <div class="setup-desc-row">ğŸ‘† <span>ç”»é¢å³ã‚¿ãƒƒãƒ— â†’ æ¬¡ã®ã‚»ãƒªãƒ•ã¸</span></div>
        <div class="setup-desc-row">ğŸ‘† <span>ç”»é¢å·¦ã‚¿ãƒƒãƒ— â†’ ã‚‚ã†ä¸€åº¦èª­ã¿ä¸Šã’</span></div>
      </div>
      <button class="btn btn-primary btn-full" style="margin-top:32px;padding:16px;font-size:16px" onclick="startPrompterSession()">â–¶ èª­ã¿ä¸Šã’é–‹å§‹</button>
    </div>
  </div>

  <!-- SESSION SCREEN -->
  <div id="prompterSession" style="display:none">
    <div class="prompter-header">
      <div class="prompter-title" id="prompterSessionTitle"></div>
      <div class="prompter-counter" id="prompterCounter"></div>
      <button class="prompter-close" onclick="closePrompter()">âœ•</button>
    </div>

    <!-- TAP ZONES -->
    <div class="tap-zone-left"  onclick="handleTap('left')"></div>
    <div class="tap-zone-right" onclick="handleTap('right')"></div>

    <!-- MAIN BODY -->
    <div class="prompter-body">
      <div class="prompter-speaker-label" id="prompterSpeaker"></div>
      <div class="prompter-text" id="prompterText"></div>
      <div class="prompter-direction" id="prompterDirection" style="display:none"></div>
    </div>

    <!-- STATUS BAR -->
    <div class="prompter-status" id="prompterStatus">
      <div class="status-icon" id="statusIcon">ğŸ”Š</div>
      <div class="status-msg"  id="statusMsg">èª­ã¿ä¸Šã’ä¸­...</div>
    </div>

    <!-- TRANSCRIPT (shown on mismatch) -->
    <div class="prompter-transcript" id="prompterTranscript" style="display:none">
      <div class="transcript-label">èãå–ã‚Šçµæœ</div>
      <div class="transcript-text" id="transcriptText"></div>
    </div>

    <!-- BOTTOM HINT -->
    <div class="prompter-hint" id="prompterHint">
      <div class="hint-left" onclick="handleTap('left')">â† ã‚‚ã†ä¸€åº¦</div>
      <div class="hint-right" onclick="handleTap('right')">æ¬¡ã¸ â†’</div>
    </div>
  </div>
</div>

<script>
let allShots = [];
let headers = [];
let rawRows = [];
let currentFilter = 'all';

function setSource(src) {
  document.getElementById('srcBtnExcel').classList.toggle('active', src === 'excel');
  document.getElementById('srcBtnSheets').classList.toggle('active', src === 'sheets');
  document.getElementById('excelArea').style.display = src === 'excel' ? '' : 'none';
  document.getElementById('sheetsArea').classList.toggle('visible', src === 'sheets');
  document.getElementById('parseSection').style.display = 'none';
}

const zone = document.getElementById('uploadZone');
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      if (rows.length < 2) { showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      headers = rows[0].map(String);
      rawRows = rows.slice(1).filter(r => r.some(c => String(c).trim()));
      showParseUI(`ã€Œ${file.name}ã€`, rawRows.length);
    } catch(e) { showToast('âš ï¸ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message); }
  };
  reader.readAsArrayBuffer(file);
}

function showGasStep(n) {
  document.getElementById('gasStepPanel1').style.display = n === 1 ? '' : 'none';
  document.getElementById('gasStepPanel2').style.display = n === 2 ? '' : 'none';
  document.getElementById('gasStep1').classList.toggle('active', n === 1);
  document.getElementById('gasStep2').classList.toggle('active', n === 2);
}
showGasStep(1);

function copyCode() {
  const code = document.getElementById('gasCode').textContent;
  navigator.clipboard.writeText(code).then(() => showToast('ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

function autoFillId(val) {
  // If user pastes a full spreadsheet URL into the ID field, extract the ID
  const match = val.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (match) document.getElementById('sheetsId').value = match[1];
}

async function loadSheets() {
  const gasUrl = document.getElementById('gasUrl').value.trim();
  const sheetId = document.getElementById('sheetsId').value.trim();
  const sheetName = document.getElementById('sheetsName').value.trim();

  if (!gasUrl) { showToast('âš ï¸ GAS ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!gasUrl.includes('script.google.com')) { showToast('âš ï¸ GASã®URLã§ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
  if (!sheetId) { showToast('âš ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const loading = document.getElementById('sheetsLoading');
  loading.style.display = '';

  try {
    let url = `${gasUrl}?id=${encodeURIComponent(sheetId)}`;
    if (sheetName) url += `&sheet=${encodeURIComponent(sheetName)}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${res.status}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length < 2) {
      throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒˆåã‚„IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }

    headers = data[0].map(String);
    rawRows = data.slice(1).filter(r => r.some(c => String(c).trim()));
    showParseUI('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ', rawRows.length);
    showToast(`âœ… ${rawRows.length}è¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  } catch(err) {
    showToast('âš ï¸ ' + err.message);
    console.error(err);
  }
  loading.style.display = 'none';
}

function parseCSV(text) {
  const rows = [];
  for (const line of text.split(/\r?\n/)) {
    if (!line.trim()) continue;
    const row = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') { if (inQ && line[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
      else if (c === ',' && !inQ) { row.push(cur); cur = ''; }
      else cur += c;
    }
    row.push(cur); rows.push(row);
  }
  return rows;
}

function showParseUI(label, count) {
  document.getElementById('parseInfo').textContent = `${label} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚${count}è¡Œã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å„åˆ—ã®å½¹å‰²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
  const fields = [
    { key: 'title', label: 'ğŸ”´ æ’®å½±ã‚¿ã‚¤ãƒˆãƒ«', required: true },
    { key: 'url',   label: 'âšª å‚è€ƒå‹•ç”»URL' },
    { key: 'time',  label: 'âšª å‚è€ƒç§’æ•°' },
    { key: 'note',  label: 'âšª èª¬æ˜ãƒ»ãƒˆæ›¸ã' },
  ];
  document.getElementById('columnMap').innerHTML = fields.map(f => `
    <div class="col-row">
      <div class="col-label">${f.label}</div>
      <select class="col-select" id="col_${f.key}">
        ${headers.map(h => `<option ${guess(h, f.key) ? 'selected' : ''}>${escHtml(h)}</option>`).join('')}
        ${!f.required ? '<option value="">(ãªã—)</option>' : ''}
      </select>
    </div>
  `).join('');
  document.getElementById('parseSection').style.display = '';
}

function guess(header, key) {
  const h = header.toLowerCase();
  if (key === 'title') return h.includes('ã‚¿ã‚¤ãƒˆãƒ«') || h.includes('ã‚·ãƒ¼ãƒ³') || h.includes('title') || h.includes('scene') || h.includes('åå‰');
  if (key === 'url')   return h.includes('url') || (h.includes('å‚è€ƒ') && h.includes('å‹•ç”»')) || h.includes('ãƒªãƒ³ã‚¯');
  if (key === 'time')  return h.includes('ç§’') || h.includes('time') || h.includes('å†ç”Ÿ');
  if (key === 'note')  return h.includes('èª¬æ˜') || h.includes('ãƒˆæ›¸') || h.includes('note') || h.includes('å‚™è€ƒ');
  return false;
}

function buildList() {
  const getVal = id => document.getElementById(id)?.value || '';
  const titleCol = getVal('col_title');
  if (!titleCol) { showToast('âš ï¸ æ’®å½±ã‚¿ã‚¤ãƒˆãƒ«åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const idx = col => headers.indexOf(col);
  allShots = rawRows.map((row, i) => ({
    id: i,
    title: row[idx(titleCol)] || `ã‚·ãƒ¼ãƒ³ ${i+1}`,
    url:  getVal('col_url')  ? (row[idx(getVal('col_url'))]  || '') : '',
    time: getVal('col_time') ? (row[idx(getVal('col_time'))] || '') : '',
    note: getVal('col_note') ? (row[idx(getVal('col_note'))] || '') : '',
    done: false, videos: [],
  })).filter(s => String(s.title).trim());
  renderList('all');
  updateProgress();
  switchTabDirect('list');
  showToast(`âœ… ${allShots.length}ä»¶ã®æ’®å½±ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ`);
}

function loadDemo() {
  allShots = [
    { id:0, title:'ãƒˆãƒƒãƒ—ã‚·ãƒ¼ãƒ³ - å•†å“ã‚’æ‰‹ã«å–ã‚‹', url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ', time:'0:03ã€œ0:07', note:'ç¬‘é¡”ã§å•†å“ã‚’æŒã¡ä¸Šã’ã‚‹ã€‚æ˜ã‚‹ã„ç…§æ˜æ¨å¥¨ã€‚ç™½èƒŒæ™¯ãŒãƒ™ã‚¹ãƒˆã€‚', done:false, videos:[] },
    { id:1, title:'ä½¿ç”¨ã‚·ãƒ¼ãƒ³ - å®Ÿéš›ã«ä½¿ã£ã¦ã„ã‚‹ã¨ã“ã‚', url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ', time:'0:12ã€œ0:18', note:'è‡ªç„¶ãªè¡¨æƒ…ã§ã€‚æ‰‹å…ƒã‚’ãƒ¡ã‚¤ãƒ³ã«æ’®ã‚‹ã€‚ç¸¦æ’®ã‚Šæ¨å¥¨ã€‚', done:false, videos:[] },
    { id:2, title:'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒ³ - é©šãã®è¡¨æƒ…', url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ', time:'0:05', note:'ã€Œãˆã£ï¼ã€ã¨ã„ã†é©šãã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚ã‚ªãƒ¼ãƒãƒ¼æ°—å‘³ã§OKã€‚', done:true, videos:[{blob:'', filename:'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒ³_é©šãã®è¡¨æƒ…_1.mp4'}] },
    { id:3, title:'ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ— - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ­£é¢', url:'', time:'', note:'ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ­£é¢ã‚’ã—ã£ã‹ã‚Šæ˜ ã™ã€‚ãƒ–ãƒ¬ãªã„ã‚ˆã†ã«å›ºå®šæ’®å½±ã€‚', done:false, videos:[] },
    { id:4, title:'ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° - å•†å“ã¨ä¸€ç·’ã«ç¬‘é¡”', url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ', time:'0:20ã€œ0:25', note:'æ¸…æ½”æ„Ÿã‚ã‚‹èƒŒæ™¯ã§ç· ã‚ã€‚ãƒ­ã‚´ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã€‚', done:false, videos:[] },
  ];
  renderList('all');
  updateProgress();
  switchTabDirect('list');
}

function switchTab(name, el) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  el.classList.add('active');
  if (name === 'export') updateExportCount();
}
function switchTabDirect(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  document.querySelectorAll('.tab')[{upload:0,list:1,export:2}[name]].classList.add('active');
}

function filterList(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderList(f);
}

function renderList(filter) {
  const list = document.getElementById('shootList');
  let shots = allShots;
  if (filter === 'todo') shots = shots.filter(s => !s.done);
  if (filter === 'done') shots = shots.filter(s => s.done);
  if (!shots.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">${filter==='done'?'ğŸ“­':'ğŸ‰'}</div><div>${filter==='done'?'ã¾ã å®Œäº†ã—ãŸæ’®å½±ãŒã‚ã‚Šã¾ã›ã‚“':'ã™ã¹ã¦å®Œäº†ã—ã¦ã„ã¾ã™ï¼'}</div></div>`;
    return;
  }
  list.innerHTML = shots.map(s => `
    <div class="shoot-card ${s.done ? 'done' : ''}" id="card_${s.id}">
      <div class="shoot-card-header" onclick="toggleCard(${s.id})">
        <div class="scene-num">#${String(s.id+1).padStart(2,'0')}</div>
        <div class="scene-title">${escHtml(s.title)}</div>
        <div class="status-pill">${s.done ? 'âœ… å®Œäº†' : 'æœªå®Œäº†'}</div>
        <div class="chevron">â–¶</div>
      </div>
      <div class="shoot-card-body">
        ${s.isScript ? `
          ${s.note ? `<div class="detail-label">å ´é¢è¨­å®š</div><div class="detail-text">${escHtml(s.note)}</div>` : ''}
          ${s.fv ? `<div class="detail-label">FVã®ä»•æ›ã‘</div><div class="detail-text">${escHtml(s.fv)}</div>` : ''}
          ${s.costume ? `<div class="detail-label">æœè£…</div><div class="detail-text">${escHtml(s.costume)}</div>` : ''}
          <div class="detail-label">ã‚»ãƒªãƒ• <span style="color:var(--accent)">${s.lines ? s.lines.length : 0}è¡Œ</span></div>
          <div class="script-preview">
            ${s.lines ? s.lines.slice(0,3).map(l => `
              <div class="script-line">
                <span class="script-speaker">${escHtml(l.speaker)}</span>
                <span class="script-text">${escHtml(l.line)}</span>
              </div>`).join('') : ''}
            ${s.lines && s.lines.length > 3 ? `<div style="color:var(--text-muted);font-size:12px;padding:4px 0">... ä»–${s.lines.length-3}è¡Œ</div>` : ''}
          </div>
          <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center" onclick="openScriptPrompter(${s.id})">
            ğŸ“º ãƒ—ãƒ­ãƒ³ãƒ—ã‚¿ãƒ¼ï¼ˆã‚»ãƒªãƒ•èª­ã¿ä¸Šã’ï¼‰
          </button>
        ` : `
          ${s.note ? `
            <div class="detail-label">æ’®å½±å†…å®¹ãƒ»ãƒˆæ›¸ã</div>
            <div class="detail-text">${escHtml(s.note)}</div>
            ${s.note.includes('\n') || s.note.length > 20 ? `
              <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="openPrompter(${s.id})">
                ğŸ“º ãƒ—ãƒ­ãƒ³ãƒ—ã‚¿ãƒ¼è¡¨ç¤º
              </button>` : ''}
          ` : ''}
        `}

        ${s.url ? `
        <div class="detail-label">å‚è€ƒå‹•ç”»</div>
        <div class="video-ref-box">
          <div class="video-ref-meta">
            <div class="video-ref-icon">${getPlatformIcon(detectPlatform(s.url))}</div>
            <div class="video-ref-info">
              <div class="platform-badge">${getPlatformLabel(detectPlatform(s.url))}</div>
              <a href="${escHtml(s.url)}" target="_blank" class="video-ref-url">${escHtml(s.url)}</a>
              ${s.time ? `<div class="video-ref-time">â± ${escHtml(s.time)}</div>` : ''}
            </div>
            ${canEmbed(detectPlatform(s.url))
              ? `<button class="video-preview-toggle" onclick="toggleEmbed(event,${s.id})">â–¶ å†ç”Ÿ</button>`
              : `<button class="video-preview-toggle" onclick="window.open('${escHtml(s.url)}','_blank')">â†— é–‹ã</button>`
            }
          </div>
          <div class="video-embed-wrap" id="embed_${s.id}"></div>
        </div>` : ''}

        <div class="detail-label">
          æ’®å½±ã—ãŸå‹•ç”»
          ${s.videos.length > 0 ? `<span class="video-count-badge">${s.videos.length}æœ¬</span>` : ''}
        </div>
        <div id="videoList_${s.id}">
          ${s.videos.map((v, vi) => `
            <div class="shot-video-item">
              <div class="video-tap-wrap" onclick="playVideoInline(this)"><video playsinline webkit-playsinline preload="metadata" style="width:100%;display:block;max-height:240px;background:#000" onplay="this.parentElement.querySelector('.play-overlay').style.display='none'" onpause="this.parentElement.querySelector('.play-overlay').style.display='flex'"><source src="${v.blob}" type="${v.mimeType||'video/mp4'}"></video><div class="play-overlay"><div class="play-btn-big">â–¶</div></div></div>
              <div class="shot-video-info">
                <div class="shot-video-name">${escHtml(v.filename)}</div>
                <button class="btn btn-ghost btn-sm" onclick="removeVideo(${s.id},${vi})">âœ•</button>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="shot-video-drop">
          <input type="file" accept="video/*" onchange="handleShotVideo(${s.id}, this.files[0]); this.value=''">
          ğŸ“¹ ${s.videos.length > 0 ? '+ å‹•ç”»ã‚’è¿½åŠ ' : 'å‹•ç”»ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ'}
        </div>

        ${s.done ? `
          <div class="done-badge">âœ… æ’®å½±å®Œäº†ã€€${s.videos.length}æœ¬ç™»éŒ²æ¸ˆã¿</div>
          <div class="shoot-actions">
            <button class="btn btn-ghost btn-sm" onclick="undone(${s.id})">â†© æœªå®Œäº†ã«æˆ»ã™</button>
          </div>
        ` : `
          <div class="shoot-actions">
            <button class="btn btn-primary" onclick="markDone(${s.id})">âœ… æ’®å½±å®Œäº†ã«ã™ã‚‹</button>
            <button class="btn btn-ghost" onclick="openCamera(${s.id})">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
          </div>
          <div class="camera-note">ğŸ’¡ ã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã¸ã®è‡ªå‹•ä¿å­˜ã¯iOSã‚¢ãƒ—ãƒªç‰ˆã§å¯¾å¿œäºˆå®šã€‚æ’®å½±å¾Œã¯ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã§ä¿å­˜ã—ã¦ã‹ã‚‰ã€Œå‹•ç”»ã‚’è¿½åŠ ã€ã§ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</div>
        `}
      </div>
    </div>
  `).join('');
}

function toggleCard(id) {
  document.getElementById('card_' + id).classList.toggle('open');
}

// â”€â”€ VIDEO PLATFORM DETECTION
function detectPlatform(url) {
  const u = String(url);
  if (/youtube\.com|youtu\.be/.test(u))        return 'youtube';
  if (/tiktok\.com/.test(u))                   return 'tiktok';
  if (/instagram\.com/.test(u))                return 'instagram';
  if (/twitter\.com|x\.com/.test(u))           return 'twitter';
  if (/vimeo\.com/.test(u))                    return 'vimeo';
  if (/drive\.google\.com/.test(u))            return 'gdrive';
  if (/\.(mp4|mov|webm|m4v)(\?|$)/i.test(u))  return 'direct';
  return 'other';
}

function getPlatformLabel(platform) {
  return { youtube:'YouTube', tiktok:'TikTok', instagram:'Instagram',
    twitter:'X (Twitter)', vimeo:'Vimeo', gdrive:'Googleãƒ‰ãƒ©ã‚¤ãƒ–',
    direct:'å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«', other:'å¤–éƒ¨ãƒªãƒ³ã‚¯' }[platform] || 'å¤–éƒ¨ãƒªãƒ³ã‚¯';
}

function getPlatformIcon(platform) {
  return { youtube:'â–¶ï¸', tiktok:'ğŸµ', instagram:'ğŸ“¸', twitter:'ğŸ¦',
    vimeo:'ğŸ¬', gdrive:'ğŸ“', direct:'ğŸ¥', other:'ğŸ”—' }[platform] || 'ğŸ”—';
}

function canEmbed(platform) {
  return ['youtube', 'vimeo', 'gdrive', 'direct'].includes(platform);
}

function toggleEmbed(e, id) {
  e.stopPropagation();
  const wrap = document.getElementById('embed_' + id);
  if (wrap.classList.contains('visible')) {
    wrap.classList.remove('visible'); wrap.innerHTML = ''; return;
  }
  const s = allShots.find(x => x.id === id);
  const platform = detectPlatform(s.url);
  const startSec = parseTimeSec(s.time);

  if (platform === 'youtube') {
    const ytId = extractYtId(s.url);
    if (!ytId) { window.open(s.url, '_blank'); return; }
    wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${ytId}?start=${startSec}&autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;

  } else if (platform === 'vimeo') {
    const m = s.url.match(/vimeo\.com\/(\d+)/);
    if (!m) { window.open(s.url, '_blank'); return; }
    wrap.innerHTML = `<iframe src="https://player.vimeo.com/video/${m[1]}?autoplay=1#t=${startSec}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;

  } else if (platform === 'gdrive') {
    // Convert share URL to embed URL
    const fileMatch = s.url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (!fileMatch) { window.open(s.url, '_blank'); return; }
    wrap.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileMatch[1]}/preview" allow="autoplay" allowfullscreen></iframe>`;

  } else if (platform === 'direct') {
    wrap.innerHTML = `<video controls autoplay src="${escHtml(s.url)}" style="width:100%;display:block;max-height:300px"></video>`;

  } else {
    // TikTok, Instagram, X etc â†’ open externally
    window.open(s.url, '_blank');
    return;
  }

  wrap.classList.add('visible');
}

function extractYtId(url) {
  const m = String(url).match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?.*v=|embed\/|shorts\/))([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}
function parseTimeSec(timeStr) {
  if (!timeStr) return 0;
  const first = String(timeStr).split(/[ã€œ~\-â€“]/)[0].trim();
  const parts = first.split(':');
  if (parts.length === 2) return parseInt(parts[0])*60 + (parseInt(parts[1])||0);
  return parseInt(parts[0]) || 0;
}

function handleShotVideo(id, file) {
  if (!file) return;
  const s = allShots.find(x => x.id === id);
  const safe = s.title.replace(/[\\/:*?"<>|]/g, '_');
  const ext = (file.name.split('.').pop() || 'mp4').toLowerCase();
  const num = s.videos.length + 1;
  const filename = `${safe}_${num}.${ext}`;

  // Determine correct MIME type - Safari needs exact MIME
  let mimeType = file.type;
  if (!mimeType || mimeType === 'application/octet-stream') {
    const mimeMap = { mov: 'video/mp4', mp4: 'video/mp4', m4v: 'video/mp4',
                      webm: 'video/webm', ogv: 'video/ogg', '3gp': 'video/3gpp' };
    mimeType = mimeMap[ext] || 'video/mp4';
  }
  // MOV from iPhone = H.264 inside QuickTime container, re-wrap as mp4 blob
  if (ext === 'mov') mimeType = 'video/mp4';

  // Create blob URL with explicit MIME type (more reliable than base64 in Safari)
  const blob = new Blob([file], { type: mimeType });
  const blobUrl = URL.createObjectURL(blob);

  s.videos.push({ blob: blobUrl, filename, mimeType, isBlob: true });
  showToast(`ğŸ“¹ ${filename}`);
  refreshVideoList(id);
  updateProgress();
}

// â”€â”€ VIDEO PLAYBACK
function playVideoInline(wrap) {
  const vid = wrap.querySelector('video');
  if (!vid) return;
  if (vid.paused) {
    vid.play().catch(e => showToast('âš ï¸ ' + e.name + ': ' + e.message));
  } else {
    vid.pause();
  }
}

// â”€â”€ CAMERA
function openCamera(id) {
  // Create a temporary file input with capture=environment to open camera
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'video/*';
  input.setAttribute('capture', 'environment');
  input.onchange = (e) => {
    if (e.target.files[0]) handleShotVideo(id, e.target.files[0]);
  };
  input.click();
  // Note: iOS Safari will open camera but saving to camera roll requires native app
  showToast('ğŸ“· æ’®å½±å¾Œã€å‹•ç”»ã¯è‡ªå‹•ã§ã“ã®ã‚¢ãƒ—ãƒªã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™');
}

function refreshVideoList(id) {
  const s = allShots.find(x => x.id === id);
  const listEl = document.getElementById('videoList_' + id);
  if (!listEl) return;

  // Clear and rebuild using DOM API (avoids Safari innerHTML video src bug)
  listEl.innerHTML = '';
  s.videos.forEach((v, vi) => {
    // Wrapper
    const item = document.createElement('div');
    item.className = 'shot-video-item';
    item.id = `shotItem_${id}_${vi}`;

    // Tap wrap
    const tapWrap = document.createElement('div');
    tapWrap.className = 'video-tap-wrap';

    // Video element â€” set src via JS property, not HTML attribute
    const vid = document.createElement('video');
    vid.id = `shotVid_${id}_${vi}`;
    vid.setAttribute('playsinline', '');
    vid.setAttribute('webkit-playsinline', '');
    vid.setAttribute('preload', 'metadata');
    vid.setAttribute('controls', '');
    vid.style.cssText = 'width:100%;display:block;max-height:240px;background:#000';
    // Directly set src property â€” most reliable in Safari
    vid.src = v.blob;
    vid.type = v.mimeType || 'video/mp4';

    // Overlay
    const overlay = document.createElement('div');
    overlay.className = 'play-overlay';
    overlay.innerHTML = '<div class="play-btn-big">â–¶</div>';

    vid.addEventListener('play',  () => overlay.style.display = 'none');
    vid.addEventListener('pause', () => overlay.style.display = 'flex');
    vid.addEventListener('error', (e) => {
      console.error('video error', vid.error);
      showToast('âš ï¸ å‹•ç”»èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + (vid.error ? vid.error.message : 'ä¸æ˜'));
    });

    tapWrap.appendChild(vid);
    tapWrap.appendChild(overlay);
    tapWrap.addEventListener('click', () => {
      if (vid.paused) {
        vid.play().catch(e => showToast('âš ï¸ ' + e.name + ': ' + e.message));
      } else {
        vid.pause();
      }
    });

    // Info row
    const info = document.createElement('div');
    info.style.cssText = 'display:flex;gap:8px;padding:8px 10px;align-items:center;border-top:1px solid #2e2e2e';
    info.innerHTML = `<div style="flex:1;font-size:11px;font-family:monospace;color:#ffb800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(v.filename)}</div>`;
    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-ghost btn-sm';
    delBtn.textContent = 'âœ•';
    delBtn.onclick = () => removeVideo(id, vi);
    info.appendChild(delBtn);

    item.appendChild(tapWrap);
    item.appendChild(info);
    listEl.appendChild(item);
  });

  // Update drop zone
  const dropEl = listEl.nextElementSibling;
  if (dropEl) {
    dropEl.innerHTML = '';
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'video/*';
    inp.onchange = (e) => { if(e.target.files[0]) handleShotVideo(id, e.target.files[0]); inp.value=''; };
    const txt = document.createTextNode('ğŸ“¹ ' + (s.videos.length > 0 ? '+ å‹•ç”»ã‚’è¿½åŠ ' : 'å‹•ç”»ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ'));
    dropEl.appendChild(inp);
    dropEl.appendChild(txt);
  }
  // Update count badge
  const badge = document.getElementById('vcBadge_' + id);
  if (badge) badge.textContent = s.videos.length > 0 ? s.videos.length + 'æœ¬' : '';
}

function removeVideo(id, vi) {
  const s = allShots.find(x => x.id === id);
  if (s.videos[vi].isBlob) URL.revokeObjectURL(s.videos[vi].blob);
  s.videos.splice(vi, 1);
  // Renumber filenames
  const safe = s.title.replace(/[\\/:*?"<>|]/g, '_');
  s.videos.forEach((v, i) => {
    const ext = v.filename.split('.').pop();
    v.filename = `${safe}_${i+1}.${ext}`;
  });
  if (s.videos.length === 0) s.done = false;
  refreshVideoList(id);
  updateProgress();
  // update count badge
  const badge = document.querySelector(`#card_${id} .video-count-badge`);
  if (badge) badge.textContent = s.videos.length > 0 ? s.videos.length + 'æœ¬' : '';
}

function markDone(id) {
  const s = allShots.find(x => x.id === id);
  s.done = true;
  const label = s.videos.length > 0 ? `${s.videos.length}æœ¬ç™»éŒ²æ¸ˆã¿` : 'ãƒ•ã‚¡ã‚¤ãƒ«æœªç™»éŒ²';
  showToast(`âœ… å®Œäº†! ${label}`);
  renderList(currentFilter); updateProgress();
}
function undone(id) { allShots.find(x => x.id === id).done = false; renderList(currentFilter); updateProgress(); }

function updateProgress() {
  const done = allShots.filter(s => s.done).length, total = allShots.length;
  const badge = document.getElementById('progressBadge');
  badge.style.display = total ? '' : 'none';
  document.getElementById('doneCount').textContent = done;
  document.getElementById('totalCount').textContent = total;
}
function updateExportCount() { document.getElementById('exportDone').textContent = allShots.filter(s => s.done).length; }

function exportCSV() {
  if (!allShots.length) { showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const header = ['#', 'ã‚¿ã‚¤ãƒˆãƒ«', 'å‚è€ƒURL', 'å‚è€ƒç§’æ•°', 'èª¬æ˜', 'çŠ¶æ…‹', 'ãƒ•ã‚¡ã‚¤ãƒ«å'];
  const rows = allShots.map(s => [s.id+1, s.title, s.url, s.time, s.note, s.done?'å®Œäº†':'æœªå®Œäº†', s.videos.map(v=>v.filename).join(' / ')]);
  const csv = [header, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], { type: 'text/csv;charset=utf-8' });
  Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'æ’®å½±ãƒªã‚¹ãƒˆ.csv' }).click();
  showToast('ğŸ“Š CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}

// â”€â”€ MODE TOGGLE
let currentMode = 'instruction';
function setMode(mode) {
  currentMode = mode;
  document.getElementById('modeInstruction').classList.toggle('active', mode === 'instruction');
  document.getElementById('modeScript').classList.toggle('active', mode === 'script');
  // instruction areas
  document.getElementById('excelArea').style.display = mode === 'instruction' ? '' : 'none';
  const sheetsArea = document.getElementById('sheetsArea');
  if (sheetsArea.classList.contains('visible') && mode !== 'instruction') sheetsArea.classList.remove('visible');
  document.getElementById('instructionSourceToggle').style.display = mode === 'instruction' ? '' : 'none';
  document.getElementById('parseSection').style.display = 'none';
  // script area
  document.getElementById('scriptUploadArea').style.display = mode === 'script' ? '' : 'none';
}

// â”€â”€ SCRIPT (å°æœ¬) PARSING
function handleScriptFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      parseScriptWorkbook(wb, file.name);
    } catch(err) { showToast('âš ï¸ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); }
  };
  reader.readAsArrayBuffer(file);
}

function parseScriptWorkbook(wb, filename) {
  const scenarios = [];

  wb.SheetNames.forEach(sheetName => {
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
    if (rows.length < 3) return;

    // â”€â”€ Detect layout type
    const layout = detectScriptLayout(rows);
    console.log('Layout detected:', layout, 'for sheet:', sheetName);

    if (layout === 'multi-character') {
      // Layout A: columns = characters (å‰å›ã®å°æœ¬å½¢å¼)
      parseMultiCharLayout(rows, sheetName, scenarios);
    } else {
      // Layout B: rows = lines, col B=scene, col C=text, col D=direction
      parseSingleColLayout(rows, sheetName, scenarios);
    }
  });

  if (scenarios.length === 0) {
    showToast('âš ï¸ ã‚·ãƒŠãƒªã‚ªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    return;
  }

  allShots = scenarios;
  renderList('all');
  updateProgress();
  switchTabDirect('list');
  showToast(`âœ… ${scenarios.length}ä»¶ã®ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
}

// â”€â”€ DETECT LAYOUT
function detectScriptLayout(rows) {
  // Multi-character: has 'å½¹æŸ„' label in col B
  for (let i = 0; i < Math.min(rows.length, 12); i++) {
    if (rows[i] && String(rows[i][1] || '').includes('å½¹æŸ„')) return 'multi-character';
  }
  // Single-col: has header row with ãƒ†ã‚­ã‚¹ãƒˆ/æ˜ åƒ or scene IDs like op1,op2
  for (let i = 0; i < Math.min(rows.length, 20); i++) {
    const r = rows[i];
    if (!r) continue;
    const b = String(r[1] || ''), c = String(r[2] || ''), d = String(r[3] || '');
    if (c.includes('ãƒ†ã‚­ã‚¹ãƒˆ') || d.includes('æ˜ åƒ') || /^op\d/.test(b)) return 'single-col';
  }
  return 'single-col';
}

// â”€â”€ LAYOUT A: Multi-character columns
function parseMultiCharLayout(rows, sheetName, scenarios) {
  let charRow = -1, roleRow = -1;
  for (let i = 0; i < Math.min(rows.length, 10); i++) {
    const r = rows[i];
    if (r && String(r[1]||'') === 'å½¹æŸ„') { roleRow = i; }
    const nonNull = (r||[]).filter((v,j) => j > 1 && v);
    if (nonNull.length >= 1 && roleRow === -1) charRow = i;
  }
  if (charRow === -1) charRow = 4;

  const charCols = {};
  (rows[charRow]||[]).forEach((val, j) => {
    if (j > 1 && val) charCols[j] = String(val).trim();
  });
  if (Object.keys(charCols).length === 0) return;

  let setting = '', fv = '', costume = '';
  rows.forEach(r => {
    if (!r || !r[1]) return;
    const label = String(r[1]);
    if (label.includes('å ´é¢è¨­å®š')) setting = String(r[2]||'');
    if (label.includes('FV'))      fv      = String(r[2]||'');
    if (label.includes('æœè£…'))    costume = Object.keys(charCols).map(j => `${charCols[j]}: ${r[j]||''}`).filter(v => !v.endsWith(': ')).join(' / ');
  });

  const lines = [];
  const scriptStart = Math.max(roleRow, charRow) + 3;
  for (let i = scriptStart; i < rows.length; i++) {
    const r = rows[i];
    if (!r) continue;
    Object.keys(charCols).forEach(j => {
      const val = r[j];
      if (val !== null && val !== undefined && String(val).trim()) {
        lines.push({ speaker: charCols[j], line: String(val).trim(), direction: '' });
      }
    });
  }

  if (lines.length > 0) {
    scenarios.push({
      id: scenarios.length, title: sheetName, note: setting,
      fv, costume, lines, url: '', time: '',
      done: false, videos: [], isScript: true,
    });
  }
}

// â”€â”€ LAYOUT B: Single text column with directions (ä»Šå›ã®å½¢å¼)
function parseSingleColLayout(rows, sheetName, scenarios) {
  // Find header row (contains ãƒ†ã‚­ã‚¹ãƒˆ or æ¦‚è¦)
  let headerRow = -1;
  for (let i = 0; i < Math.min(rows.length, 25); i++) {
    const r = rows[i];
    if (!r) continue;
    const rowStr = r.map(v => String(v||'')).join('');
    if (rowStr.includes('ãƒ†ã‚­ã‚¹ãƒˆ') || rowStr.includes('æ¦‚è¦') || rowStr.includes('ç™ºä¿¡è€…')) {
      headerRow = i; break;
    }
  }
  if (headerRow === -1) headerRow = 17; // fallback

  // Detect column positions from header
  const headerData = rows[headerRow] || [];
  let textCol = 2, dirCol = 3; // defaults: C=text, D=direction
  headerData.forEach((val, j) => {
    const v = String(val||'').trim();
    if (v === 'ãƒ†ã‚­ã‚¹ãƒˆ' || v === 'ã‚»ãƒªãƒ•') textCol = j;
    if (v === 'æ˜ åƒ' || v === 'æ˜ åƒæŒ‡ç¤º' || v === 'ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼') dirCol = j;
  });

  // Extract metadata from top rows
  let refUrl = '', note = '';
  for (let i = 0; i < headerRow; i++) {
    const r = rows[i];
    if (!r) continue;
    const label = String(r[1]||'').trim();
    if (label === 'å‚è€ƒå‹•ç”»') {
      refUrl = String(r[textCol] || r[2] || '').split('\n')[0].trim();
    }
    if (label === 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ' || label === 'å ´é¢è¨­å®š') {
      note = String(r[textCol] || r[2] || '').trim();
    }
  }

  // Extract lines
  const lines = [];
  let currentScene = '';
  for (let i = headerRow + 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r) continue;

    const sceneId = String(r[1]||'').trim();
    const text    = String(r[textCol]||'').trim();
    const dir     = String(r[dirCol]  ||'').trim();

    if (sceneId && sceneId !== 'None') currentScene = sceneId;
    if (!text || text === 'null') continue;
    // Skip formula cells
    if (text.startsWith('=')) continue;

    lines.push({
      speaker:   currentScene,
      line:      text,
      direction: dir,
    });
  }

  if (lines.length > 0) {
    scenarios.push({
      id: scenarios.length,
      title: sheetName,
      note, fv: '', costume: '',
      lines, url: refUrl, time: '',
      done: false, videos: [], isScript: true,
    });
  }
}


// â”€â”€ OPEN PROMPTER (show setup screen)
function openPrompter(id) {
  const s = allShots.find(x => x.id === id);
  if (!s || !s.note) return;
  prompterLines = s.note.split(/\n/).map(l => l.trim()).filter(l => l.length > 0)
                   .map(l => ({ speaker: '', line: l }));
  if (prompterLines.length === 0) return;
  _showPrompterSetup(s.title);
}

function openScriptPrompter(id) {
  const s = allShots.find(x => x.id === id);
  if (!s || !s.lines || s.lines.length === 0) return;
  prompterLines = s.lines.map(l => ({ speaker: l.speaker, line: l.line }));
  _showPrompterSetup(s.title);
}

function _showPrompterSetup(title) {
  prompterIdx = 0;
  sessionActive = false;
  document.getElementById('prompterTitle').textContent = title;
  document.getElementById('prompterSetup').style.display  = 'flex';
  document.getElementById('prompterSession').style.display = 'none';
  document.getElementById('prompterOverlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  const el = document.getElementById('prompterOverlay');
  if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}

function selectTolerance(level) {
  toleranceLevel = level;
  document.querySelectorAll('.setup-opt').forEach(b => b.classList.remove('active'));
  document.getElementById('opt-' + level).classList.add('active');
}

// â”€â”€ START SESSION
function startPrompterSession() {
  document.getElementById('prompterSetup').style.display   = 'none';
  document.getElementById('prompterSession').style.display = 'flex';
  document.getElementById('prompterSessionTitle').textContent =
    document.getElementById('prompterTitle').textContent;
  sessionActive = true;
  renderPrompter('');
  speakLine();
}

// â”€â”€ CLOSE PROMPTER
function closePrompter() {
  sessionActive = false;
  stopSpeech();
  stopListening();
  clearAutoNext();
  document.getElementById('prompterOverlay').style.display = 'none';
  document.body.style.overflow = '';
  if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
  else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
}

// â”€â”€ RENDER
function renderPrompter(animClass) {
  const line = prompterLines[prompterIdx];
  const total = prompterLines.length;

  document.getElementById('prompterCounter').textContent = `${prompterIdx+1} / ${total}`;
  document.getElementById('prompterSpeaker').textContent = line.speaker || '';

  const textEl = document.getElementById('prompterText');
  textEl.className = 'prompter-text' + (animClass ? ' ' + animClass : '');
  textEl.textContent = line.line;

  // Direction (æ˜ åƒæŒ‡ç¤º)
  const dirEl = document.getElementById('prompterDirection');
  if (dirEl) {
    if (line.direction) {
      dirEl.textContent = 'ğŸ¬ ' + line.direction;
      dirEl.style.display = '';
    } else {
      dirEl.style.display = 'none';
    }
  }

  // Hide transcript on new line
  document.getElementById('prompterTranscript').style.display = 'none';
  document.getElementById('transcriptText').textContent = '';

}

function setStatus(icon, msg) {
  document.getElementById('statusIcon').textContent = icon;
  document.getElementById('statusMsg').textContent  = msg;
}

// â”€â”€ SPEAK current line
function speakLine() {
  if (!sessionActive) return;
  clearAutoNext();

  if (!('speechSynthesis' in window)) {
    setStatus('ğŸ‘†', 'â† ã‚‚ã†ä¸€åº¦ ï¼ æ¬¡ã¸ â†’');
    return;
  }

  window.speechSynthesis.cancel();

  // Wait for cancel to complete, then speak
  requestAnimationFrame(() => requestAnimationFrame(() => {
    if (!sessionActive) return;
    const line = prompterLines[prompterIdx];
    const utt = new SpeechSynthesisUtterance(line.line);
    utt.lang = 'ja-JP';
    utt.rate = 0.9;
    utt.volume = 1;

    const voices = window.speechSynthesis.getVoices();
    const jaVoice = voices.find(v => v.lang && v.lang.startsWith('ja'));
    if (jaVoice) utt.voice = jaVoice;

    utt.onstart = () => setStatus('ğŸ”Š', 'èª­ã¿ä¸Šã’ä¸­...');
    utt.onend   = () => { if (sessionActive) setStatus('ğŸ‘†', 'â† ã‚‚ã†ä¸€åº¦ ï¼ æ¬¡ã¸ â†’'); };
    utt.onerror = (e) => {
      if (!sessionActive) return;
      if (e.error === 'interrupted' || e.error === 'canceled') return;
      // TTS failed (e.g. Safari local file) - show tap hint instead
      setStatus('ğŸ‘†', 'â† ã‚‚ã†ä¸€åº¦ ï¼ æ¬¡ã¸ â†’');
    };

    setStatus('ğŸ”Š', 'èª­ã¿ä¸Šã’ä¸­...');
    window.speechSynthesis.speak(utt);

    // Safari stall fix: resume if paused after 1s
    setTimeout(() => {
      if (window.speechSynthesis.paused) window.speechSynthesis.resume();
    }, 1000);
  }));
}
function stopSpeech() {
  window.speechSynthesis.cancel();
}

// â”€â”€ SPEECH RECOGNITION (disabled - Safari blocks mic on local files)
function startListening() {
  // Mic recognition disabled - use tap or voice "æ¬¡"/"ã‚‚ã†ä¸€åº¦" not available
  // Just wait for user tap
}

function stopListening() {}

// â”€â”€ TRANSCRIPT HANDLER (disabled)
function handleTranscript(t) {}


// â”€â”€ NAVIGATION
function goNext() {
  clearAutoNext();
  stopListening();
  if (prompterIdx >= prompterLines.length - 1) {
    setStatus('ğŸ‰', 'å…¨ã‚»ãƒªãƒ•å®Œäº†ï¼');
    document.getElementById('prompterText').textContent = 'å®Œäº†ï¼';
    document.getElementById('prompterSpeaker').textContent = '';
    sessionActive = false;
    return;
  }
  prompterIdx++;
  renderPrompter('slide-left');
  speakLine();
}

function retry() {
  clearAutoNext();
  stopListening();
  document.getElementById('prompterTranscript').style.display = 'none';
  renderPrompter('');
  speakLine();
}

function clearAutoNext() {
  if (autoNextTimer) { clearTimeout(autoNextTimer); autoNextTimer = null; }
}

// â”€â”€ TAP ZONES
function handleTap(side) {
  if (!sessionActive) return;
  if (side === 'right') goNext();
  else retry();
}

// â”€â”€ KEYBOARD
document.addEventListener('keydown', e => {
  if (document.getElementById('prompterOverlay').style.display === 'none') return;
  if (e.key === 'ArrowRight') goNext();
  if (e.key === 'ArrowLeft')  retry();
  if (e.key === 'Escape')     closePrompter();
});


function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
